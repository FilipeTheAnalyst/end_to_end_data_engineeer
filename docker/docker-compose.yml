services:
  postgres:
    image: postgres:16
    container_name: e2e_postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Metabase UI
  metabase:
    image: metabase/metabase:latest
    container_name: e2e_metabase
    depends_on:
      - postgres
    environment:
      MB_DB_TYPE: ${MB_DB_TYPE:-postgres}
      MB_DB_HOST: ${MB_DB_HOST:-postgres}
      MB_DB_PORT: ${MB_DB_PORT:-5432}
      MB_DB_DBNAME: ${MB_DB_DBNAME:-metabase}
      MB_DB_USER: ${MB_DB_USER:-metabase}
      MB_DB_PASS: ${MB_DB_PASS:-metabase}
    ports:
      - "3001:3000"

  # Airbyte (minimal local setup)
  # Note: Airbyte can be heavy. This is a starting point; tune resources as needed.
  airbyte-db:
    image: postgres:16
    container_name: e2e_airbyte_db
    environment:
      POSTGRES_USER: airbyte
      POSTGRES_PASSWORD: airbyte
      POSTGRES_DB: airbyte
    ports:
      - "5433:5432"
    volumes:
      - airbyte_db_data:/var/lib/postgresql/data

  airbyte-server:
    image: airbyte/server:latest
    container_name: e2e_airbyte_server
    depends_on:
      - airbyte-db
    environment:
      DATABASE_USER: airbyte
      DATABASE_PASSWORD: airbyte
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      DATABASE_DB: airbyte
      DATABASE_HOST: airbyte-db
      DATABASE_PORT: 5432
      DATABASE_USER: airbyte
      DATABASE_PASSWORD: airbyte
      WORKSPACE_ROOT: /workspace
    volumes:
      - airbyte_workspace:/workspace

  airbyte-webapp:
    image: airbyte/webapp:latest
    container_name: e2e_airbyte_webapp
    depends_on:
      - airbyte-server
    environment:
      AIRBYTE_SERVER_HOST: airbyte-server
      AIRBYTE_SERVER_PORT: 8001
    ports:
      - "8000:80"

  # Dagster (webserver only; daemon optional)
  dagster:
    build:
      context: ../orchestration/dagster
    container_name: e2e_dagster
    env_file:
      - .env
    ports:
      - "3000:3000"
    volumes:
      - ../orchestration/dagster:/app
      - ../extract:/extract
      - ../transform/dbt:/dbt

  # OpenMetadata is typically run via its official compose.
  # Here we provide placeholders; see observability/openmetadata/README.md.

volumes:
  postgres_data:
  airbyte_db_data:
  airbyte_workspace:
